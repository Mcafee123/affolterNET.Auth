# This workflow tests the switch-references.sh script functionality
# It verifies:
# - Help and configuration validation
# - Switching between local and NuGet references
# - Proper detection of reference types (fixes "NO REFERENCE FOUND" issue)
# - Error handling for missing configuration files
# - .NET restore and build compatibility
# - File content verification after switches

name: Switch References Test

on:
  push:
  pull_request:

jobs:
  test-switch-references:
    runs-on: ubuntu-latest
    
    env:
      ACTIONS_RUNNER_DEBUG: true
      ACTIONS_STEP_DEBUG: true
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        
    - name: Verify prerequisites
      run: |
        echo "Checking for required tools..."
        which jq && jq --version || echo "jq not found"
        which dotnet && dotnet --version || echo "dotnet not found"
        which timeout && timeout --version || echo "timeout not found"
        echo "System information:"
        uname -a
        echo "Environment variables:"
        env | grep -E "(ACTIONS_|RUNNER_)" | sort
        echo "Verifying configuration file..."
        jq empty reference-config.json && echo "✅ Configuration file is valid JSON" || echo "❌ Configuration file is invalid"
      
    - name: Test help functionality
      run: |
        echo "=== Testing Help Command ==="
        ./switch-references.sh --help
        
    - name: Test validation
      run: |
        echo "=== Testing Configuration Validation ==="
        ./switch-references.sh validate
        
    - name: Show initial status
      run: |
        echo "=== Initial Reference Status ==="
        echo "Current working directory: $(pwd)"
        echo "Files in current directory:"
        ls -la
        echo "Script permissions:"
        ls -la switch-references.sh
        echo "Project files exist check:"
        ls -la affolterNET.Web.*/
        echo "Configuration file:"
        cat reference-config.json
        echo "Starting dotnet restore..."
        # First, ensure dotnet is working and do a restore
        dotnet restore || { echo "FAILED: dotnet restore"; exit 1; }
        echo "dotnet restore completed successfully"
        echo "Starting switch-references.sh status with 60 second timeout..."
        timeout 60 ./switch-references.sh status || { 
          echo "FAILED: switch-references.sh status (exit code: $?)"; 
          echo "Checking if process timed out...";
          if [ $? -eq 124 ]; then
            echo "ERROR: Script timed out after 60 seconds";
          fi
          exit 1; 
        }
        echo "switch-references.sh status completed successfully"
        
    - name: Test switch to NuGet references
      run: |
        echo "=== Testing Switch to NuGet References ==="
        ./switch-references.sh nuget
        
    - name: Verify NuGet references in project files
      run: |
        echo "=== Verifying NuGet References in Project Files ==="
        echo "Checking affolterNET.Web.Api project:"
        grep -n "PackageReference.*affolterNET.Web.Core" affolterNET.Web.Api/affolterNET.Web.Api.csproj || echo "No PackageReference found"
        echo "Checking affolterNET.Web.Bff project:"
        grep -n "PackageReference.*affolterNET.Web.Core" affolterNET.Web.Bff/affolterNET.Web.Bff.csproj || echo "No PackageReference found"
        
    - name: Show status after NuGet switch
      run: |
        echo "=== Status After NuGet Switch ==="
        ./switch-references.sh status
        
    - name: Test switch back to local references
      run: |
        echo "=== Testing Switch Back to Local References ==="
        ./switch-references.sh local
        
    - name: Verify local references in project files
      run: |
        echo "=== Verifying Local References in Project Files ==="
        echo "Checking affolterNET.Web.Api project:"
        grep -n "ProjectReference.*affolterNET.Web.Core" affolterNET.Web.Api/affolterNET.Web.Api.csproj || echo "No ProjectReference found"
        echo "Checking affolterNET.Web.Bff project:"
        grep -n "ProjectReference.*affolterNET.Web.Core" affolterNET.Web.Bff/affolterNET.Web.Bff.csproj || echo "No ProjectReference found"
        
    - name: Show final status
      run: |
        echo "=== Final Reference Status ==="
        ./switch-references.sh status
        
    - name: Test custom config parameter
      run: |
        echo "=== Testing Custom Config Parameter ==="
        ./switch-references.sh status --config reference-config.json
        
    - name: Test error handling with invalid config
      run: |
        echo "=== Testing Error Handling ==="
        ./switch-references.sh status --config non-existent.json && exit 1 || echo "✅ Correctly handled missing config file"
        
    - name: Test dotnet restore with local references
      run: |
        echo "=== Testing .NET Restore with Local References ==="
        dotnet restore --verbosity minimal
        
    - name: Verify project builds with local references
      run: |
        echo "=== Testing Build with Local References ==="
        dotnet build --no-restore --verbosity minimal
        
    - name: Summary of tests
      run: |
        echo "=========================================="
        echo "✅ All switch-references.sh tests passed!"
        echo "✅ Help command works"
        echo "✅ Configuration validation works"
        echo "✅ Status reporting works"
        echo "✅ NuGet reference switching works"
        echo "✅ Local reference switching works"
        echo "✅ Custom config parameter works"
        echo "✅ Error handling works"
        echo "✅ .NET restore and build work"
        echo "=========================================="